<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Exam — ProctorVision</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">ProctorVision</div>
    <div class="navlinks small">
      <span id="stuTxt">Student</span> &nbsp;|&nbsp; <a href="dashboard.html">Exit</a>
    </div>
  </header>

  <div class="container">
    <div class="grid-2">
      <div class="card-plain">
        <h3>Questions</h3>
        <div style="height:300px;overflow:auto">
          <p><strong>Q1.</strong> Demo: Write a short answer.</p>
          <textarea style="width:100%;height:140px;padding:10px" placeholder="Type here..."></textarea>
        </div>
        <div style="margin-top:12px">
          <button class="btn" onclick="finishExam()">Submit & Finish</button>
        </div>
      </div>

      <div class="card-plain">
        <h3>Monitoring</h3>
        <video id="preview2" class="preview" autoplay playsinline muted></video>
        <div style="margin-top:10px">
          <div class="small">Session: <span id="sid">—</span></div>
          <div style="margin-top:10px">
            <div>Risk</div>
            <div class="risk-bar" style="margin-top:6px;">
              <div id="riskFill" class="risk-fill"></div>
            </div>
            <h2 id="riskValue" style="margin:8px 0">0%</h2>
            <div id="riskStatus" class="small">Status: <em>Low</em></div>
            <div id="alertsBox" class="alert"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Basic runtime monitoring logic
const preview2 = document.getElementById('preview2');
const sidEl = document.getElementById('sid');
const riskFill = document.getElementById('riskFill');
const riskValue = document.getElementById('riskValue');
const riskStatus = document.getElementById('riskStatus');
const alertsBox = document.getElementById('alertsBox');

let sessionId = localStorage.getItem('sessionId') || 'sess-demo';
sidEl.innerText = sessionId;
document.getElementById('stuTxt').innerText = localStorage.getItem('studentName') || 'Student';

let stream = null;
let mouseDist = 0;
let lastMouse = null;
let keyTimes = [];
let tabSwitches = 0;
let idleSeconds = 0;
let lastActivity = Date.now();
let trackingInterval = null;

// Start camera if allowed
async function startCamera(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({video:{width:640,height:360}, audio:false});
    preview2.srcObject = stream;
  } catch(err){
    console.warn('Camera not available:', err.message);
  }
}
startCamera();

// Mouse tracking
document.addEventListener('mousemove', (e) => {
  const now = Date.now();
  if(lastMouse) {
    const dx = e.clientX - lastMouse.x;
    const dy = e.clientY - lastMouse.y;
    mouseDist += Math.hypot(dx,dy);
  }
  lastMouse = {x:e.clientX, y:e.clientY, t: now};
  lastActivity = now;
});

// Key timing
document.addEventListener('keydown', (e) => {
  const now = Date.now();
  if(keyTimes.length>0) keyTimes.push(now - keyTimes[keyTimes.length-1]);
  else keyTimes.push(now);
  if(keyTimes.length > 100) keyTimes.shift();
  lastActivity = now;
});

// Tab switch detection
document.addEventListener('visibilitychange', () => {
  if(document.hidden) tabSwitches++;
  lastActivity = Date.now();
});

// Idle detection increment
setInterval(() => {
  if(Date.now() - lastActivity > 5000) idleSeconds += 1;
}, 1000);

// Compute risk every 2 seconds
setInterval(() => {
  // mouseSpeed = mouseDist / interval
  const mouseSpeed = Math.round(mouseDist);
  mouseDist = 0;
  const keyVar = calcVariance(keyTimes.slice(-40)) || 0;
  const idle = idleSeconds;
  // basic heuristic
  let risk = 0;
  risk += Math.min(keyVar * 0.02 * 100, 25);   // weird typing variance
  risk += Math.min(tabSwitches * 12, 40);
  risk += idle > 6 ? 22 : 0;
  risk += mouseSpeed < 30 ? 12 : 0;
  // random small noise to simulate ML component
  risk += Math.random()*6;
  risk = Math.min(100, Math.round(risk));
  updateRisk(risk);

  // simulate ML alert: if multiple tab switches quickly
  if(tabSwitches >= 3 && Math.random() < 0.6){
    showAlert('MULTIPLE_TABS', 'high', 'Multiple tab switches detected');
  }
}, 2000);

function calcVariance(arr){
  if(!arr || arr.length < 2) return 0;
  const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
  const v = arr.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b,0)/arr.length;
  return v;
}

function updateRisk(risk){
  riskFill.style.width = risk + '%';
  riskValue.innerText = risk + '%';
  if(risk < 40) { riskFill.style.background = 'green'; riskStatus.innerText = 'Low'; alertsBox.style.display='none'; }
  else if(risk < 70) { riskFill.style.background = 'orange'; riskStatus.innerText='Medium'; alertsBox.style.display='none'; }
  else { riskFill.style.background = 'red'; riskStatus.innerText='High'; /* show alert area if any */ }
}

function showAlert(code, severity, text){
  alertsBox.innerText = text;
  alertsBox.style.display = 'block';
  // save event in localStorage log for demo
  const log = JSON.parse(localStorage.getItem('events') || '[]');
  log.push({sessionId, ts: new Date().toISOString(), code, severity, text});
  localStorage.setItem('events', JSON.stringify(log));
}

// cleanup on finish
function finishExam(){
  if(confirm('Submit exam and finish?')){
    // For demo: store integrity summary
    const summary = {sessionId, integrity:Math.max(0,100 - parseInt(riskValue.innerText)), endedAt:new Date().toISOString()};
    localStorage.setItem('lastSummary', JSON.stringify(summary));
    window.location.href = 'dashboard.html';
  }
}
</script>
</body>
</html>
